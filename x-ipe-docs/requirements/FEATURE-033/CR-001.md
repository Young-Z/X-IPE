# Change Request: CR-001

> Created: 2026-02-14
> Status: Approved
> Classification: Modification
> Related Feature: FEATURE-033

## Request Details

**Requestor:** Human (project owner)
**Date Received:** 2026-02-14
**Priority:** Medium

## Description

Add an `inject_script` MCP tool to the existing `x-ipe-app-and-agent-interaction` MCP server. The tool reads a JavaScript file from the local filesystem and executes it in a Chrome browser page via Chrome DevTools Protocol (CDP), enabling agents to inject scripts without consuming context window tokens.

The primary use case is UIUX Reference toolbar injection: instead of the agent reading `toolbar.min.js` (~24KB) into its context and relaying it through `evaluate_script`, the agent calls `inject_script(file_path)` and the MCP server handles the file→browser transfer directly.

## Business Justification

- **Context token savings**: Each injection currently costs ~48KB of context tokens (read + paste). Over a typical session with 5-6 re-injections during iterative testing, this wastes ~72K tokens.
- **Reduced error surface**: Manual copy-paste of JavaScript through the agent introduces unicode escaping issues, template literal problems, and truncation risks.
- **Single tool call**: Reduces 2-3 tool calls per injection to 1.
- **Time savings**: ~2-3 seconds per injection (modest but compounds).

## Impact Analysis

### Classification

**Type:** Modification to FEATURE-033

**Reasoning:**
- Same users (CLI agents)
- Same MCP server process (`x-ipe-app-and-agent-interaction`)
- Same transport (stdio)
- Same architecture pattern (MCP tool → backend service)
- No new data models, UI screens, or user roles
- Adds a new tool registration to the existing extensible tool pattern (FR-033.7)
- The CDP connection is a new integration point, but it's an implementation detail within the existing MCP server boundary

This is a **modification** per classification criteria: works within current system boundaries, builds upon existing tool registration pattern, same users with extended functionality.

### Comparison Matrix

| Aspect | CR Requirement | Existing FEATURE-033 |
|--------|---------------|---------------------|
| Users | CLI agents (Copilot, Claude, OpenCode) | CLI agents (Copilot, Claude, OpenCode) |
| Workflow | Agent → MCP `inject_script` → read file → CDP → browser | Agent → MCP `save_uiux_reference` → Flask → filesystem |
| Data Model | No new data model (reads .js file, no persistence) | Reference data JSON schema |
| UI Elements | None | None |
| API Endpoints | New MCP tool `inject_script` (no Flask endpoint needed) | MCP tool `save_uiux_reference` + Flask `POST /api/ideas/uiux-reference` |

### Affected Components

| Component | Impact Level | Details |
|-----------|--------------|---------|
| `src/x_ipe/mcp/app_agent_interaction.py` | Medium | Add `inject_script` tool registration |
| `src/x_ipe/mcp/cdp_client.py` | New file | Reusable lightweight CDP WebSocket client |
| `pyproject.toml` | Low | Add `websockets` dependency |
| `.github/skills/x-ipe-tool-uiux-reference/SKILL.md` | Low | Update injection step to prefer `inject_script` |

### Dependencies

- Chrome must be running with `--remote-debugging-port=9222` for CDP access
- `websockets` Python package for CDP WebSocket communication
- No Flask backend dependency (unlike `save_uiux_reference`)

## Proposed Approach

1. Create `src/x_ipe/mcp/cdp_client.py` — lightweight CDP client (~50 lines):
   - `GET /json` to discover pages
   - WebSocket connection to page's `webSocketDebuggerUrl`
   - Send `Runtime.evaluate` message, receive result
   - Short-lived connection (connect → evaluate → disconnect)

2. Add `inject_script` tool to `app_agent_interaction.py`:
   - Read `.js` file from `file_path`
   - Optional `cleanup_before` flag to remove existing toolbar
   - Connect to CDP, evaluate script, return result
   - Structured error responses matching existing pattern

3. Add `websockets` to `pyproject.toml` dependencies

4. Update SKILL.md injection step to prefer `inject_script` with `evaluate_script` fallback

## Mockup Impact

**UI/UX Change:** No

## Approval

- [x] Classification approved by human (auto-proceed enabled)
- [x] Approach approved by human (auto-proceed enabled)
- [x] Ready for execution

## Execution

**Classification Result:** modification

**Actions Taken:**
- [x] CR document created in feature folder
- [x] Specification Version History updated with CR link
- [ ] Next task type set: x-ipe-task-based-feature-refinement

## Links

- Feature Specification: [specification.md](./specification.md)
- Technical Design: [technical-design.md](./technical-design.md)
- Idea Summary: [020. CR-MCP for script injection](../../ideas/020.%20CR-MCP%20for%20script%20injection%20for%20UIUX%20Reference%20tool/idea-summary-v1.md)

---

## Change History

| Date | Change | By |
|------|--------|----|
| 2026-02-14 | CR created | Bolt (agent) |
