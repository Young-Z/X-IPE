(() => {
if (window.__xipeToolbarInjected) return;
window.__xipeToolbarInjected = true;
const D = document, B = document.body, H = document.documentElement;
const R = window.__xipeRefData = { mode: 'theme', colors: [], components: [], design_tokens: null };
window.__xipeRefReady = false;
window.__xipeRefCommand = null;
const modeReg = {}, modeCont = {};
let activeMode = 'theme', toastEl;

// --- Shared helpers ---
function el(tag, cls, html) {
  const e = D.createElement(tag);
  if (cls) e.className = cls;
  if (html) e.innerHTML = html;
  return e;
}
function css(e, s) { e.style.cssText = s; }
window.__xipeToast = (msg, type = 'info', dur = 3000) => {
  if (!toastEl) return;
  const t = el('div', 'xt xt-' + type, '<span class="xti">' + ({info:'‚Ñπ',progress:'‚è≥',success:'‚úì',error:'‚úó'}[type]||'‚Ñπ') + '</span><span class="xtm">' + msg + '</span>');
  toastEl.appendChild(t);
  while (toastEl.children.length > 3) toastEl.removeChild(toastEl.firstChild);
  if (type !== 'error') setTimeout(() => { if (t.parentNode) t.remove(); }, dur);
};
window.__xipeGenerateSelector = el => {
  if (!el || el === B || el === H) return 'body';
  if (el.id) return '#' + CSS.escape(el.id);
  const parts = [];
  let c = el;
  while (c && c !== B && c !== H) {
    let p = c.tagName.toLowerCase();
    const sc = [...c.classList].filter(x => !/[0-9a-f]{6,}|__|--[a-z0-9]{4,}/i.test(x)).filter(x => !x.startsWith('x'+'ipe-')).slice(0, 2);
    if (sc.length) p += '.' + sc.map(CSS.escape).join('.');
    else { const sibs = [...(c.parentElement?.children||[])].filter(s => s.tagName === c.tagName); if (sibs.length > 1) p += ':nth-of-type(' + (sibs.indexOf(c)+1) + ')'; }
    parts.unshift(p); c = c.parentElement;
  }
  return 'body > ' + parts.join(' > ');
};
window.__xipeRegisterMode = (name, fn) => { modeReg[name] = fn; if (modeCont[name] && name === activeMode) fn(modeCont[name]); };

// --- Styles (single block) ---
const style = D.createElement('style');
style.textContent = `
.xipe-toolbar{position:fixed;top:50%;right:20px;z-index:2147483647;font-family:system-ui,sans-serif;user-select:none;transform:translateY(-50%)}
.xipe-ham{width:52px;height:52px;background:linear-gradient(135deg,#3730a3,#4f46e5);border:2px solid rgba(255,255,255,.25);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:grab;color:#fff;font-size:9px;font-weight:700;letter-spacing:.08em;box-shadow:0 4px 16px rgba(55,48,163,.35);transition:all .4s cubic-bezier(.22,1,.36,1)}
.xipe-ham:hover{background:linear-gradient(135deg,#4f46e5,#7c3aed,#a855f7);transform:scale(1.1)}
.xp{position:absolute;right:62px;top:50%;transform:translateY(-50%);width:280px;max-height:80vh;background:#0f172a;border:1px solid rgba(255,255,255,.1);border-radius:16px;overflow:hidden;transition:width 350ms cubic-bezier(.22,1,.36,1),opacity 350ms;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.xp.xc{width:0;opacity:0;pointer-events:none;overflow:hidden;border:none}
.xph{padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:8px}
.xph .dot{width:6px;height:6px;border-radius:50%;background:#10b981}
.xph .ttl{color:#e2e8f0;font-size:13px;font-weight:600}
.xmt{display:flex;gap:4px;padding:8px 12px}
.xmt button{flex:1;padding:6px 8px;background:0 0;border:1px solid rgba(255,255,255,.12);border-radius:8px;color:#94a3b8;font-size:11px;font-weight:500;cursor:pointer;text-align:center;transition:all .2s;font-family:inherit}
.xmt button.xa{background:#10b981;color:#fff;border-color:#10b981}
.xmc{padding:12px;overflow-y:auto;max-height:calc(80vh - 120px);min-height:100px}
.xta{padding:8px 12px}
.xt{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;font-size:11px;color:#e2e8f0;margin-bottom:4px;animation:xsi .3s ease}
.xt-info{background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3)}
.xt-progress{background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.3)}
.xt-success{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3)}
.xt-error{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3)}
.xti{font-size:14px}.xtm{flex:1}
@keyframes xsi{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.xsi{display:flex;gap:4px;padding:8px 0;margin-bottom:8px}
.xsd{flex:1;height:3px;border-radius:2px;background:rgba(255,255,255,.1)}
.xsd.xa{background:#10b981}
.xsl{font-size:11px;color:#94a3b8;margin-bottom:8px}
.xb{display:block;width:100%;padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;margin-top:8px;font-family:inherit}
.xb1{background:#10b981;color:#fff}.xb1:hover{background:#059669}
.xb1:disabled{background:#374151;color:#6b7280;cursor:not-allowed}
.xb2{background:rgba(255,255,255,.08);color:#e2e8f0}
.xbt{background:rgba(255,255,255,.08);color:#e2e8f0;border:1px solid rgba(255,255,255,.15)}
.xbt.xon{background:#10b981;color:#fff;border-color:#10b981}
.xnb{display:flex;gap:6px;margin-top:10px}.xnb .xb{flex:1}
.xsw{position:fixed;padding:4px 10px;border-radius:12px;font-size:11px;font-family:monospace;color:#fff;pointer-events:none;z-index:2147483646;animation:xfo 3s forwards}
@keyframes xfo{0%,70%{opacity:1}100%{opacity:0}}
.xcr{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;color:#e2e8f0}
.xcs{width:16px;height:16px;border-radius:50%;flex-shrink:0;border:1px solid rgba(255,255,255,.2)}
.xch{font-family:monospace;font-size:10px}
.xcx{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:12px;margin-left:auto;opacity:0;transition:opacity .2s;font-family:inherit}
.xcr:hover .xcx{opacity:1}
.xrr{display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);flex-wrap:wrap}
.xrc{display:flex;gap:4px;align-items:center}
.xrp{padding:2px 8px;border-radius:12px;font-size:10px;border:1px solid rgba(255,255,255,.2);background:0 0;color:#94a3b8;cursor:pointer;transition:all .2s;font-family:inherit}
.xrp.xa{background:#10b981;color:#fff;border-color:#10b981}
.xri{width:60px;padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#e2e8f0;font-size:10px;font-family:inherit}
.xsh{position:fixed;border:2px solid rgba(59,130,246,.6);background:rgba(59,130,246,.08);pointer-events:none;z-index:2147483645;transition:all .08s ease-out}
.xsh .xtb{background:rgba(59,130,246,.85)}
.xso{position:fixed;border:2px dashed #10b981;pointer-events:none;z-index:2147483646;display:none}
.xso.xoa{display:block}
.xtb{position:absolute;top:-22px;left:0;background:#10b981;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-family:monospace;pointer-events:none}
.xdh{position:absolute;width:8px;height:8px;background:#10b981;pointer-events:auto;border-radius:1px}
.xkr{display:flex;align-items:center;gap:6px;padding:6px 4px;font-size:11px;color:#e2e8f0;border-bottom:1px solid rgba(255,255,255,.06);cursor:pointer;border-radius:4px;transition:background .15s}
.xkr:hover{background:rgba(255,255,255,.04)}
.xkr.xka{background:rgba(16,185,129,.15);border-left:2px solid #10b981}
.xkt{background:rgba(16,185,129,.15);color:#10b981;padding:1px 5px;border-radius:4px;font-size:9px;font-family:monospace}
.xks{color:#64748b;font-size:9px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:120px}
.xkd{color:#94a3b8;font-size:9px}
.xkx{background:none;border:none;color:#94a3b8;cursor:pointer;font-size:12px;margin-left:auto;opacity:0;transition:opacity .2s}
.xkr:hover .xkx{opacity:1}
.xii{width:100%;padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:#e2e8f0;font-size:10px;margin-top:4px;font-family:inherit}
`;
D.head.appendChild(style);

// --- Build toolbar shell ---
const toolbar = el('div', 'xipe-toolbar');
const ham = el('div', 'xipe-ham');
ham.textContent = 'X-IPE';
toolbar.appendChild(ham);
const panel = el('div', 'xp xc');
const header = el('div', 'xph', '<span class="dot"></span><span class="ttl">X-IPE Reference</span>');
panel.appendChild(header);
const tabs = el('div', 'xmt');
const modes = [{id:'theme',label:'üé® Catch Theme'},{id:'mockup',label:'üìê Copy Mockup'}];
const tabBtns = modes.map(m => {
  const b = el('button');
  b.textContent = m.label;
  b.dataset.mode = m.id;
  if (m.id === activeMode) b.classList.add('xa');
  b.onclick = () => switchMode(m.id);
  tabs.appendChild(b);
  return b;
});
panel.appendChild(tabs);
const content = el('div', 'xmc');
modes.forEach(m => {
  const c = el('div');
  c.className = 'xm-' + m.id;
  css(c, 'display:' + (m.id === activeMode ? 'block' : 'none'));
  modeCont[m.id] = c;
  content.appendChild(c);
});
panel.appendChild(content);
toastEl = el('div', 'xta');
panel.appendChild(toastEl);
toolbar.appendChild(panel);
B.appendChild(toolbar);

function switchMode(mode) {
  if (window.__xipeThemeDeactivate) window.__xipeThemeDeactivate();
  if (window.__xipeMockupDeactivate) window.__xipeMockupDeactivate();
  activeMode = mode; R.mode = mode;
  tabBtns.forEach(t => t.classList.toggle('xa', t.dataset.mode === mode));
  Object.entries(modeCont).forEach(([n, e]) => { css(e, 'display:' + (n === mode ? 'block' : 'none')); });
  if (modeReg[mode] && !modeCont[mode].dataset.init) { modeReg[mode](modeCont[mode]); modeCont[mode].dataset.init = '1'; }
}

// --- Panel expand/collapse ---
let cTimer = null;
function expand() { panel.classList.remove('xc'); }
function collapse() { panel.classList.add('xc'); }
ham.addEventListener('mouseenter', () => { clearTimeout(cTimer); expand(); });
panel.addEventListener('mouseenter', () => { clearTimeout(cTimer); });
panel.addEventListener('mouseleave', () => { cTimer = setTimeout(collapse, 2000); });
ham.addEventListener('mouseleave', () => { cTimer = setTimeout(collapse, 2000); });

// --- Drag ---
let dragging = false, dx = 0, dy = 0;
ham.addEventListener('mousedown', e => { dragging = true; dx = e.clientX - toolbar.getBoundingClientRect().left; dy = e.clientY - toolbar.getBoundingClientRect().top; ham.style.cursor = 'grabbing'; e.preventDefault(); });
D.addEventListener('mousemove', e => { if (!dragging) return; css(toolbar, 'left:' + Math.max(10, Math.min(innerWidth-62, e.clientX-dx)) + 'px;top:' + Math.max(10, Math.min(innerHeight-62, e.clientY-dy)) + 'px;right:auto;transform:none;position:fixed;z-index:2147483647'); });
D.addEventListener('mouseup', () => { if (dragging) { dragging = false; ham.style.cursor = 'grab'; } });

// --- Commands ---
function pollCommands() {
  const cmd = window.__xipeRefCommand;
  if (!cmd) return;
  window.__xipeRefCommand = null;
  if (cmd.action === 'deep_capture') {
    const comp = R.components.find(c => c.id === cmd.target);
    if (!comp) return;
    const target = D.querySelector(comp.selector);
    if (!target) return;
    const st = getComputedStyle(target), all = {};
    for (let i = 0; i < st.length; i++) all[st[i]] = st.getPropertyValue(st[i]);
    comp.html_css = { level: 'deep', computed_styles: all, outer_html: target.outerHTML };
    window.__xipeRefReady = true;
  } else if (cmd.action === 'reset') {
    R.colors = []; R.components = []; R.design_tokens = null;
    window.__xipeToast('Data reset', 'info');
  }
}
setInterval(pollCommands, 1000);

// --- Step wizard helper (shared by both modes) ---
function buildWizard(container, steps, currentStep, setStep, renderStep) {
  container.innerHTML = '';
  const ind = el('div', 'xsi');
  steps.forEach((_, i) => { const d = el('div', 'xsd' + (i < currentStep ? ' xa' : '')); ind.appendChild(d); });
  container.appendChild(ind);
  const lb = el('div', 'xsl');
  lb.textContent = 'Step ' + currentStep + '/' + steps.length + ': ' + steps[currentStep - 1];
  container.appendChild(lb);
  const scs = [];
  steps.forEach((_, i) => { const s = el('div'); css(s, 'display:' + ((i+1) === currentStep ? 'block' : 'none')); scs.push(s); container.appendChild(s); });
  const nav = el('div', 'xnb');
  if (currentStep > 1) { const b = el('button', 'xb xb2'); b.textContent = 'Back'; b.onclick = () => setStep(currentStep - 1); nav.appendChild(b); }
  if (currentStep < steps.length) { const b = el('button', 'xb xb1'); b.textContent = 'Next'; b.onclick = () => setStep(currentStep + 1); nav.appendChild(b); }
  container.appendChild(nav);
  renderStep(scs);
  return scs;
}

// ===== THEME MODE =====
window.__xipeRegisterMode('theme', function(container) {
  let cc = 0, step = 1;
  const hasED = typeof EyeDropper !== 'undefined';

  function hexToRgb(h) { const m = h.replace('#','').match(/.{2}/g); return m ? m.map(v => parseInt(v,16)) : [0,0,0]; }
  function rgbToHsl(r,g,b) {
    r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;
    if(mx===mn)h=s=0;else{const d=mx-mn;s=l>.5?d/(2-mx-mn):d/(mx+mn);
    if(mx===r)h=((g-b)/d+(g<b?6:0))/6;else if(mx===g)h=((b-r)/d+2)/6;else h=((r-g)/d+4)/6;}
    return Math.round(h*360)+', '+Math.round(s*100)+'%, '+Math.round(l*100)+'%';
  }
  function addColor(hex) {
    const rgb = hexToRgb(hex), hsl = rgbToHsl(rgb[0],rgb[1],rgb[2]);
    cc++;
    R.colors.push({ id:'color-'+String(cc).padStart(3,'0'), hex:hex.toLowerCase(), rgb:rgb.join(', '), hsl, source_selector:'eyedropper', role:'', context:'' });
    const pill = el('div','xsw'); pill.textContent = hex; css(pill,'background:'+hex+';left:50%;top:50%;transform:translate(-50%,-50%)');
    B.appendChild(pill); setTimeout(() => pill.remove(), 3000);
    render(); window.__xipeToast('Picked '+hex, 'info', 2000);
  }
  function pickColor() {
    if (!hasED) { window.__xipeToast('EyeDropper API not supported', 'error'); return; }
    new EyeDropper().open().then(r => addColor(r.sRGBHex)).catch(() => {});
  }
  window.__xipeThemeDeactivate = () => {};

  const ROLES = ['primary','secondary','accent'];
  function render() {
    buildWizard(container, ['Pick Colors','Annotate Roles','Create Theme'], step,
      s => { step = s; render(); },
      scs => {
        if (step === 1) renderColors(scs[0]);
        else if (step === 2) renderRoles(scs[1]);
        else renderCreate(scs[2]);
      });
  }
  function renderColors(sc) {
    const tb = el('button','xb xbt'); tb.textContent = 'üéØ Pick Color'; tb.onclick = pickColor; sc.appendChild(tb);
    R.colors.forEach((c,i) => {
      const row = el('div','xcr','<span class="xcs" style="background:'+c.hex+'"></span><span class="xch">'+c.hex+'</span>');
      const rm = el('button','xcx'); rm.textContent = '√ó'; rm.onclick = () => { R.colors.splice(i,1); render(); }; row.appendChild(rm); sc.appendChild(row);
    });
    if (!R.colors.length) { const h = el('div'); css(h,'color:#64748b;font-size:11px;text-align:center;padding:12px'); h.textContent = 'Click "Pick Color" to start'; sc.appendChild(h); }
  }
  function renderRoles(sc) {
    if (!R.colors.length) { sc.innerHTML = '<div style="color:#64748b;font-size:11px;text-align:center;padding:20px">No colors. Go back.</div>'; return; }
    R.colors.forEach(c => {
      const row = el('div','xrr','<span class="xcs" style="background:'+c.hex+'"></span><span class="xch">'+c.hex+'</span>');
      const chips = el('div','xrc');
      ROLES.forEach(r => { const ch = el('button','xrp'+(c.role===r?' xa':'')); ch.textContent = r; ch.onclick = () => { c.role = r; render(); }; chips.appendChild(ch); });
      const ci = el('input'); ci.className = 'xri'; ci.placeholder = 'custom'; ci.value = ROLES.includes(c.role)?'':c.role; ci.oninput = e => { c.role = e.target.value; }; chips.appendChild(ci);
      row.appendChild(chips); sc.appendChild(row);
    });
  }
  function renderCreate(sc) {
    const assigned = R.colors.filter(c => c.role);
    const s = el('div'); css(s,'color:#e2e8f0;font-size:11px;margin-bottom:12px'); s.textContent = R.colors.length+' colors, '+assigned.length+' with roles'; sc.appendChild(s);
    R.colors.forEach(c => { const r = el('div','xcr','<span class="xcs" style="background:'+c.hex+'"></span><span class="xch">'+c.hex+'</span><span style="color:#94a3b8;font-size:10px">'+(c.role||'\u2014')+'</span>'); sc.appendChild(r); });
    const b = el('button','xb xb1'); b.textContent = 'Create Theme'; b.disabled = !assigned.length;
    b.onclick = () => { R.mode = 'theme'; window.__xipeRefReady = true; window.__xipeToast('Creating theme...','progress'); };
    sc.appendChild(b);
  }
  render();
});

// ===== MOCKUP MODE =====
window.__xipeRegisterMode('mockup', function(container) {
  let cc = 0, snap = false, aci = -1, step = 1;
  const MC = 20;
  const ST = new Set(['SECTION','NAV','ARTICLE','ASIDE','HEADER','FOOTER','MAIN','FIGURE']);
  const CP = ['display','position','flex-direction','justify-content','align-items','width','height','margin','padding','border','border-radius','background','background-color','color','font-family','font-size','font-weight','line-height','box-shadow','opacity','overflow','z-index'];
  const ols = [];
  let stBtn = null, hov = null, lastHov = null;

  function setSnap(on) { snap = on; if (!on) hideHov(); updBtn(); }
  function updBtn() { if (stBtn) { stBtn.classList.toggle('xon', snap); stBtn.textContent = snap ? 'üìê Selecting...' : 'üìê Select Area'; } }
  window.__xipeMockupDeactivate = () => { setSnap(false); aci = -1; syncOv(); };
  function setAci(i) { aci = aci === i ? -1 : i; syncOv(); render(); }
  function syncOv() { ols.forEach((o,i) => o.classList.toggle('xoa', i === aci)); }

  function findSem(target) {
    let c = target, d = 0;
    while (c && c !== B && d < 5) { if (ST.has(c.tagName) || c.getAttribute('role')) return c; c = c.parentElement; d++; }
    c = target; d = 0;
    while (c && c !== B && d < 5) { if (c.tagName === 'DIV' && c.offsetWidth > 50 && c.offsetHeight > 50) return c; c = c.parentElement; d++; }
    return null;
  }
  function showHov(e) {
    if (!snap) { hideHov(); return; }
    if (e.target.closest('.xipe-toolbar,.xso,.xsh')) return;
    const t = findSem(e.target);
    if (!t || t === B || t === H || t === lastHov) return;
    lastHov = t; const r = t.getBoundingClientRect();
    if (!hov) { hov = el('div','xsh'); hov.appendChild(el('span','xtb')); B.appendChild(hov); }
    css(hov, 'left:'+r.x+'px;top:'+r.y+'px;width:'+r.width+'px;height:'+r.height+'px;display:block');
    hov.querySelector('.xtb').textContent = t.tagName.toLowerCase();
  }
  function hideHov() { if (hov) hov.style.display = 'none'; lastHov = null; }
  D.addEventListener('mousemove', showHov, true);

  function handleClick(e) {
    if (!snap || R.mode !== 'mockup') return;
    if (e.target.closest('.xipe-toolbar,.xso')) return;
    e.preventDefault(); e.stopPropagation();
    const t = findSem(e.target);
    if (!t || t === B || t === H) { window.__xipeToast('Click a more specific element.','error'); return; }
    if (R.components.length >= MC) { window.__xipeToast('Max 20 components.','error'); return; }
    hideHov(); capture(t); setSnap(false);
  }
  D.addEventListener('click', handleClick, true);

  function capture(target) {
    cc++;
    const id = 'comp-'+String(cc).padStart(3,'0'), r = target.getBoundingClientRect(), sel = window.__xipeGenerateSelector(target), tag = target.tagName.toLowerCase();
    const st = getComputedStyle(target), cs = {}; CP.forEach(p => cs[p] = st.getPropertyValue(p));
    R.components.push({ id, selector: sel, tag, bounding_box:{x:r.x,y:r.y,width:r.width,height:r.height}, screenshot_dataurl:null, html_css:{level:'minimal',computed_styles:cs,outer_html:null}, instruction:'', agent_analysis:null });
    const ci = R.components.length - 1;
    mkOverlay(r, tag, ci); aci = ci; syncOv(); render();
    window.__xipeToast('Selected: &lt;'+tag+'&gt;','info',2000);
  }
  function mkOverlay(rect, tag, ci) {
    const ov = el('div','xso'); css(ov,'left:'+rect.x+'px;top:'+rect.y+'px;width:'+rect.width+'px;height:'+rect.height+'px');
    ov.appendChild(el('span','xtb')); ov.querySelector('.xtb').textContent = tag;
    [{x:0,y:0,c:'nw-resize',dx:-1,dy:-1},{x:.5,y:0,c:'n-resize',dx:0,dy:-1},{x:1,y:0,c:'ne-resize',dx:1,dy:-1},{x:1,y:.5,c:'e-resize',dx:1,dy:0},{x:1,y:1,c:'se-resize',dx:1,dy:1},{x:.5,y:1,c:'s-resize',dx:0,dy:1},{x:0,y:1,c:'sw-resize',dx:-1,dy:1},{x:0,y:.5,c:'w-resize',dx:-1,dy:0}].forEach(p => {
      const h = el('div','xdh'); css(h,'left:'+p.x*100+'%;top:'+p.y*100+'%;margin:-4px;cursor:'+p.c);
      h.addEventListener('mousedown', e => {
        e.preventDefault(); e.stopPropagation();
        const sx=e.clientX,sy=e.clientY,sr={x:parseFloat(ov.style.left),y:parseFloat(ov.style.top),w:parseFloat(ov.style.width),h:parseFloat(ov.style.height)};
        function mm(me){me.preventDefault();const ddx=me.clientX-sx,ddy=me.clientY-sy;let nx=sr.x,ny=sr.y,nw=sr.w,nh=sr.h;
        if(p.dx===-1){nx=sr.x+ddx;nw=sr.w-ddx;}if(p.dx===1)nw=sr.w+ddx;if(p.dy===-1){ny=sr.y+ddy;nh=sr.h-ddy;}if(p.dy===1)nh=sr.h+ddy;
        nw=Math.max(20,nw);nh=Math.max(20,nh);css(ov,'left:'+nx+'px;top:'+ny+'px;width:'+nw+'px;height:'+nh+'px');}
        function mu(){D.removeEventListener('mousemove',mm);D.removeEventListener('mouseup',mu);const comp=R.components[ci];if(comp)comp.bounding_box={x:parseFloat(ov.style.left),y:parseFloat(ov.style.top),width:parseFloat(ov.style.width),height:parseFloat(ov.style.height)};}
        D.addEventListener('mousemove',mm);D.addEventListener('mouseup',mu);
      }); ov.appendChild(h);
    });
    B.appendChild(ov); ols.push(ov);
  }
  function compRows(sc) {
    R.components.forEach((comp, i) => {
      const row = el('div','xkr'+(i===aci?' xka':''),'<span class="xkt">'+comp.tag+'</span><span class="xks">'+comp.selector+'</span><span class="xkd">'+Math.round(comp.bounding_box.width)+'√ó'+Math.round(comp.bounding_box.height)+'</span>');
      const rm = el('button','xkx'); rm.textContent = '√ó';
      rm.onclick = e => { e.stopPropagation(); R.components.splice(i,1); if(ols[i]){ols[i].remove();ols.splice(i,1);} if(aci===i)aci=-1;else if(aci>i)aci--; syncOv(); render(); };
      row.appendChild(rm);
      row.addEventListener('click', e => { if(e.target.closest('.xkx'))return; setAci(i); });
      sc.appendChild(row);
    });
    if (!R.components.length) { const h = el('div'); css(h,'color:#64748b;font-size:11px;text-align:center;padding:12px'); h.textContent = 'Toggle selector, then click on page'; sc.appendChild(h); }
  }
  function render() {
    buildWizard(container, ['Select Components','Add Instructions','Analyze','Generate'], step,
      s => { step = s; setSnap(false); render(); },
      scs => {
        if (step === 1) { stBtn = el('button','xb xbt'); stBtn.onclick = () => { const ns=!snap; setSnap(ns); if(ns){aci=-1;syncOv();} }; updBtn(); scs[0].appendChild(stBtn); compRows(scs[0]); }
        else if (step === 2) { renderInstr(scs[1]); }
        else if (step === 3) { const s=el('div');css(s,'color:#e2e8f0;font-size:11px;margin-bottom:12px');s.textContent=R.components.length+' components ready';scs[2].appendChild(s);compRows(scs[2]);const b=el('button','xb xb1');b.textContent='Analyze';b.disabled=!R.components.length;b.onclick=()=>{R.mode='mockup';window.__xipeRefReady=true;window.__xipeToast('Analyzing...','progress');};scs[2].appendChild(b); }
        else { const s=el('div');css(s,'color:#e2e8f0;font-size:11px;margin-bottom:12px');s.textContent='Ready to generate from '+R.components.length+' components';scs[3].appendChild(s);compRows(scs[3]);const b=el('button','xb xb1');b.textContent='Generate Mockup';b.disabled=!R.components.length;b.onclick=()=>{R.mode='mockup';window.__xipeRefReady=true;window.__xipeToast('Saving...','progress');};scs[3].appendChild(b); }
      });
  }
  function renderInstr(sc) {
    if (!R.components.length) { sc.innerHTML = '<div style="color:#64748b;font-size:11px;text-align:center;padding:20px">No components. Go back.</div>'; return; }
    R.components.forEach((comp, i) => {
      const w = el('div'); css(w,'margin-bottom:8px;padding:4px;border-radius:4px;cursor:pointer;'+(i===aci?'background:rgba(16,185,129,.15);border-left:2px solid #10b981;':''));
      w.innerHTML = '<div class="xkr" style="border-bottom:none"><span class="xkt">'+comp.tag+'</span><span class="xks">'+comp.selector+'</span></div>';
      w.addEventListener('click', e => { if(e.target.tagName==='INPUT')return; setAci(i); });
      const inp = el('input'); inp.className = 'xii'; inp.placeholder = 'Add notes...'; inp.value = comp.instruction; inp.oninput = e => comp.instruction = e.target.value;
      w.appendChild(inp); sc.appendChild(w);
    });
  }
  render();
});

window.__xipeToolbarReady = true;
})();
