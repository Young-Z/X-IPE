(()=>{if(!win dow.__xipeRegisterMode){console.warn('[X-IPE Theme]Core not loaded');return;}win dow.__xipeRegisterMode('theme',function ThemeModeInit(contain er){let colorCounter=0;let magnif ierActive=false;let currentStep=1;const of fscreenCanvas=document.createElement('canvas');of fscreenCanvas.width=win dow.in nerWidth;of fscreenCanvas.height=win dow.in nerHeight;const of fscreenCtx=of fscreenCanvas.getContext('2d',{willReadFrequently:true});function loadScreenshot(){if(win dow.__xipeViewportScreenshot){const img=new Image();img.onload=()=>{of fscreenCtx.drawImage(img,0,0);};img.src=win dow.__xipeViewportScreenshot;}}loadScreenshot();const screenshotPoll=setInterval(()=>{if(win dow.__xipeViewportScreenshot)loadScreenshot();},2000);let renderTimer;const debouncedRender=()=>{clearTimeout(renderTimer);renderTimer=setTimeout(()=>{of fscreenCanvas.width=win dow.in nerWidth;of fscreenCanvas.height=win dow.in nerHeight;loadScreenshot();},200);};win dow.addEventListener('scroll',debouncedRender,{passive:true});win dow.addEventListener('resize',debouncedRender,{passive:true});function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>v.toStrin g(16).padStart(2,'0')).join('');}function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min =Math.min(r,g,b);let h,s,l=(max+min )/2;if(max===min ){h=s=0;}else{const d=max-min;s=l>0.5 ? d/(2-max-min ):d/(max+min );switch(max){case r:h=((g-b)/d+(g<b ? 6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}}return `${Math.round(h*360)},${Math.round(s*100)}%,${Math.round(l*100)}%`;}const magnif ierStyle=document.createElement('style');magnif ierStyle.textContent=`
.xipe-magnif ier{position:fixed;width:120px;height:150px;poin ter-events:none;z-in dex:2147483647;display:none;}.xipe-magnif ier canvas{border-radius:50%;border:2px solid #10b981;box-shadow:0 4px 12px rgba(0,0,0,0.3);}.xipe-magnif ier-hex{text-align:center;font-family:'Space Mono',monospace;font-size:10px;color:#e2e8f0;margin -top:4px;background:rgba(15,23,42,0.8);paddin g:2px 6px;border-radius:4px;}.xipe-swatch-pill{position:fixed;paddin g:4px 10px;border-radius:12px;font-size:11px;font-family:'Space Mono',monospace;color:white;poin ter-events:none;z-in dex:2147483646;animation:xipe-fade-out 3s for wards;}@keyframes xipe-fade-out{0%,70%{opacity:1;}100%{opacity:0;}}.xipe-color-row{display:flex;align-items:center;gap:6px;paddin g:4px 0;font-size:11px;color:#e2e8f0;}.xipe-swatch{width:16px;height:16px;border-radius:50%;flex-shrin k:0;border:1px solid rgba(255,255,255,0.2);}.xipe-hex{font-family:'Space Mono',monospace;font-size:10px;}.xipe-color-remove{background:none;border:none;color:#94a3b8;cursor:poin ter;font-size:12px;margin -left:auto;opacity:0;transition:opacity 0.2s;font-family:in herit;}.xipe-color-row:hover .xipe-color-remove{opacity:1;}.xipe-role-row{display:flex;align-items:center;gap:6px;paddin g:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);flex-wrap:wrap;}.xipe-role-chips{display:flex;gap:4px;align-items:center;}.xipe-chip{paddin g:2px 8px;border-radius:12px;font-size:10px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#94a3b8;cursor:poin ter;transition:all 0.2s;font-family:in herit;}.xipe-chip.xipe-active{background:#10b981;color:white;border-color:#10b981;}.xipe-custom-role{width:60px;paddin g:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#e2e8f0;font-size:10px;font-family:in herit;}.xipe-step-in dicator{display:flex;gap:4px;paddin g:8px 0;margin -bottom:8px;}.xipe-step-dot{flex:1;height:3px;border-radius:2px;background:rgba(255,255,255,0.1);}.xipe-step-dot.xipe-active{background:#10b981;}.xipe-step-label{font-size:11px;color:#94a3b8;margin -bottom:8px;}.xipe-btn{display:block;width:100%;paddin g:8px;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:poin ter;text-align:center;transition:all 0.2s;margin -top:8px;font-family:in herit;}.xipe-btn-primary{background:#10b981;color:white;}.xipe-btn-primary:hover{background:#059669;}.xipe-btn-primary:disabled{background:#374151;color:#6b7280;cursor:not-allowed;}.xipe-btn-secondary{background:rgba(255,255,255,0.08);color:#e2e8f0;}.xipe-nav-buttons{display:flex;gap:6px;margin -top:10px;}.xipe-nav-buttons .xipe-btn{flex:1;}`;document.head.appendChild(magnif ierStyle);const magnif ier=document.createElement('div');magnif ier.class Name='xipe-magnif ier';const magnif ierCanvas=document.createElement('canvas');magnif ierCanvas.width=120;magnif ierCanvas.height=120;const magCtx=magnif ierCanvas.getContext('2d');magnif ier.appendChild(magnif ierCanvas);const hexLabel=document.createElement('div');hexLabel.class Name='xipe-magnif ier-hex';magnif ier.appendChild(hexLabel);document.body.appendChild(magnif ier);let rafId=null;function updateMagnif ier(e){if(!magnif ierActive||!of fscreenCtx)return;magnif ier.style.display='block';magnif ier.style.left=(e.clientX+20)+'px';magnif ier.style.top=(e.clientY-140)+'px';const GRID=11;const halfGrid=Math.floor(GRID/2);try{const imageData=of fscreenCtx.getImageData(e.clientX-halfGrid,e.clientY-halfGrid,GRID,GRID);magCtx.clearRect(0,0,120,120);const cellSize=120/GRID;for(let y=0;y<GRID;y++){for(let x=0;x<GRID;x++){const idx=(y*GRID+x)*4;magCtx.fillStyle=`rgb(${imageData.data[idx]},${imageData.data[idx+1]},${imageData.data[idx+2]})`;magCtx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);magCtx.strokeStyle='rgba(255,255,255,0.15)';magCtx.strokeRect(x*cellSize,y*cellSize,cellSize,cellSize);}}const center=halfGrid*cellSize+cellSize/2;magCtx.strokeStyle='#10b981';magCtx.lin eWidth=2;magCtx.begin Path();magCtx.moveTo(center,0);magCtx.lin eTo(center,120);magCtx.moveTo(0,center);magCtx.lin eTo(120,center);magCtx.stroke();const ci=(halfGrid*GRID+halfGrid)*4;hexLabel.textContent=rgbToHex(imageData.data[ci],imageData.data[ci+1],imageData.data[ci+2]);}catch(err){magCtx.fillStyle='#666';magCtx.fillRect(0,0,120,120);hexLabel.textContent='CORS';}}document.addEventListener('mousemove',(e)=>{if(!magnif ierActive)return;cancelAnimationFrame(rafId);rafId=requestAnimationFrame(()=>updateMagnif ier(e));},true);function showSwatchPill(x,y,hex){const pill=document.createElement('div');pill.class Name='xipe-swatch-pill';pill.style.left=(x+10)+'px';pill.style.top=(y-20)+'px';pill.style.background=hex;pill.textContent=hex;document.body.appendChild(pill);setTimeout(()=>{if(pill.parentNode)pill.remove();},3000);}function handleColorClick(e){if(!magnif ierActive)return;if(e.target.closest('.xipe-toolbar')||e.target.closest('.xipe-magnif ier'))return;e.preventDefault();e.stopPropagation();try{const imageData=of fscreenCtx.getImageData(e.clientX,e.clientY,1,1);const [r,g,b]=imageData.data;const hex=rgbToHex(r,g,b);const hsl=rgbToHsl(r,g,b);colorCounter++;const id=`color-${Strin g(colorCounter).padStart(3,'0')}`;const el=document.elementFromPoin t(e.clientX,e.clientY);const selector=el ? win dow.__xipeGenerateSelector(el):'unknown';win dow.__xipeRefData.colors.push({id,hex,rgb:`${r},${g},${b}`,hsl,source_selector:selector,role:'',context:''});showSwatchPill(e.clientX,e.clientY,hex);renderColorList();win dow.__xipeToast(`Picked ${hex}`,'in fo',2000);}catch(err){win dow.__xipeToast('Cross-origin content cannot be color-sampled.','error');}}document.addEventListener('click',handleColorClick,true);const steps=['Pick Colors','Annotate Roles','Create Theme'];const stepContain ers=[];function buildStepUI(){contain er.in nerHTML='';const in dicator=document.createElement('div');in dicator.class Name='xipe-step-in dicator';steps.for Each((_,i)=>{const dot=document.createElement('div');dot.class Name=`xipe-step-dot${i<currentStep ? ' xipe-active':''}`;in dicator.appendChild(dot);});contain er.appendChild(in dicator);const label=document.createElement('div');label.class Name='xipe-step-label';label.textContent=`Step ${currentStep}/3:${steps[currentStep-1]}`;contain er.appendChild(label);steps.for Each((_,i)=>{const sc=document.createElement('div');sc.class Name=`xipe-step-${i+1}`;sc.style.display=(i+1)===currentStep ? 'block':'none';stepContain ers[i]=sc;contain er.appendChild(sc);});const nav=document.createElement('div');nav.class Name='xipe-nav-buttons';if(currentStep>1){const back=document.createElement('button');back.class Name='xipe-btn xipe-btn-secondary';back.textContent='Back';back.onclick=()=>{currentStep--;buildStepUI();renderStep();};nav.appendChild(back);}if(currentStep<3){const next=document.createElement('button');next.class Name='xipe-btn xipe-btn-primary';next.textContent='Next';next.onclick=()=>{currentStep++;magnif ierActive=(currentStep===1);magnif ier.style.display='none';buildStepUI();renderStep();};nav.appendChild(next);}contain er.appendChild(nav);renderStep();}function renderStep(){if(currentStep===1){magnif ierActive=true;renderColorList();}else if(currentStep===2){magnif ierActive=false;magnif ier.style.display='none';renderRoleAnnotation();}else if(currentStep===3){magnif ierActive=false;magnif ier.style.display='none';renderCreateTheme();}}function renderColorList(){const sc=stepContain ers[0];if(!sc)return;sc.in nerHTML='';win dow.__xipeRefData.colors.for Each((color,i)=>{const row=document.createElement('div');row.class Name='xipe-color-row';row.in nerHTML=`<span class ="xipe-swatch" style="background:${color.hex}"></span><span class ="xipe-hex">${color.hex}</span><span style="color:#64748b;font-size:9px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100px">${color.source_selector}</span>`;const rmBtn=document.createElement('button');rmBtn.class Name='xipe-color-remove';rmBtn.textContent='×';rmBtn.onclick=()=>{win dow.__xipeRefData.colors.splice(i,1);renderColorList();};row.appendChild(rmBtn);sc.appendChild(row);});if(win dow.__xipeRefData.colors.length===0){sc.in nerHTML='<div style="color:#64748b;font-size:11px;text-align:center;paddin g:20px">Click anywhere on the page to pick colors</div>';}}const roles=['primary','secondary','accent'];function renderRoleAnnotation(){const sc=stepContain ers[1];if(!sc)return;sc.in nerHTML='';if(win dow.__xipeRefData.colors.length===0){sc.in nerHTML='<div style="color:#64748b;font-size:11px;text-align:center;paddin g:20px">No colors picked yet. Go back to Step 1.</div>';return;}win dow.__xipeRefData.colors.for Each((color)=>{const row=document.createElement('div');row.class Name='xipe-role-row';row.in nerHTML=`<span class ="xipe-swatch" style="background:${color.hex}"></span><span class ="xipe-hex">${color.hex}</span>`;const chips=document.createElement('div');chips.class Name='xipe-role-chips';roles.for Each(r=>{const chip=document.createElement('button');chip.class Name=`xipe-chip${color.role===r ? ' xipe-active':''}`;chip.dataset.role=r;chip.textContent=r;chip.onclick=()=>{color.role=r;renderRoleAnnotation();};chips.appendChild(chip);});const customInput=document.createElement('in put');customInput.class Name='xipe-custom-role';customInput.placeholder='custom';customInput.value=!roles.in cludes(color.role)? color.role:'';customInput.addEventListener('in put',(e)=>{color.role=e.target.value;});chips.appendChild(customInput);row.appendChild(chips);sc.appendChild(row);});}function renderCreateTheme(){const sc=stepContain ers[2];if(!sc)return;sc.in nerHTML='';const assigned=win dow.__xipeRefData.colors.filter(c=>c.role);const summary=document.createElement('div');summary.style.cssText='color:#e2e8f0;font-size:11px;margin -bottom:12px';summary.textContent=`${win dow.__xipeRefData.colors.length}colors,${assigned.length}with roles`;sc.appendChild(summary);win dow.__xipeRefData.colors.for Each(c=>{const row=document.createElement('div');row.class Name='xipe-color-row';row.in nerHTML=`<span class ="xipe-swatch" style="background:${c.hex}"></span><span class ="xipe-hex">${c.hex}</span><span style="color:#94a3b8;font-size:10px">${c.role||'—'}</span>`;sc.appendChild(row);});const btn=document.createElement('button');btn.class Name='xipe-btn xipe-btn-primary';btn.textContent='Create Theme';btn.disabled=assigned.length===0;if(assigned.length===0)btn.title='Assign at least one color role first.';btn.onclick=()=>{win dow.__xipeRefData.mode='theme';win dow.__xipeRefReady=true;win dow.__xipeToast('Creatin g theme...','progress');};sc.appendChild(btn);}buildStepUI();});})();